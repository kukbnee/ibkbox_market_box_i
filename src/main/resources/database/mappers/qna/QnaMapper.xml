<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ibk.sb.restapi.biz.service.qna.repo.QnaRepo">

    <sql id="MARKET"><include refid="com.ibk.sb.restapi.biz.service.common.repo.SchemaRepo.MARKET"/></sql>

    <!--    PagingMapper ID-->
    <sql id="pagingHeader"><include refid="com.ibk.sb.restapi.biz.service.common.repo.PageRepo.pageHeader"/></sql>
    <sql id="pagingFooter"><include refid="com.ibk.sb.restapi.biz.service.common.repo.PageRepo.pageFooter"/></sql>

    <!--    문의 리스트 조회    -->
    <select id="selectQnaList" parameterType="RequestSearchQnaVO" resultType="SummaryQnainfoVO">
        <include refid="pagingHeader"/>
            SELECT
                TBMIM.INQR_INFO_ID
                , TBMIM.PDF_INFO_ID

                , TBMIM.INQU_USIS_ID
                , TBMFIMM.BPLC_NM AS INQU_USIS_NAME
                , TBMFIMM.RPRSNTV_NM AS INQU_RPRSNTV_NM

                , TBMPIM.SELR_USIS_ID
                , TBMFIM.BPLC_NM AS SELR_USIS_NAME
                , TBMFIM.RPRSNTV_NM AS SELR_RPRSNTV_NM

                , TBMIM.RGSN_TS

                , TBMPIM.PDF_NM

                , TBMCC.TMS3_CLSF_NM AS PDF_CTGY_NAME

                , TBMPIM.AGEN_INF_ID
                , TBMPIM.PDF_STTS_ID
                , TBMPIM.PDF_PGRS_YN

                , TBMPSL.PRC_DSCS_YN
                , TBMPSL.PDF_PRC
                , TBMPSL.SALE_PRC

                , TBMPSL.COM_PRCUT_ID
                , TBMCCD.COM_CD_NM AS COM_PRCUT_NAME

                , TBMPFR.FILE_ID AS IMG_FILE_ID

                ,TO_CHAR((
                    SELECT
                        RGSN_TS
                    FROM
                        (
                            SELECT TBMIR.RGSN_TS
                            FROM <include refid="MARKET"/>TB_BOX_MKT_INQU_R TBMIR
                            WHERE 1 = 1 AND TBMIR.INQR_INFO_ID = TBMIM.INQR_INFO_ID ORDER BY TBMIR.RGSN_TS DESC
                        )
                    WHERE rownum = 1
                ),'YYYY-MM-DD HH24:MI:SS' ) AS LAST_MESSAGE_DT
                ,(
                    SELECT
                        CNFA_YN
                    FROM
                    (
                        SELECT TBMIH.CNFA_YN
                        FROM <include refid="MARKET"/>TB_BOX_MKT_INQU_R TBMIR
                        LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_INDI_H TBMIH ON TBMIH.INQR_INFO_ID = TBMIR.INQR_INFO_ID AND TBMIH.INFO_SQN = TBMIR.INFO_SQN
                        WHERE 1 = 1
                            AND TBMIR.INQR_INFO_ID = TBMIM.INQR_INFO_ID
                            AND TBMIR.RCVR_USIS_ID = #{utlinsttId}
                        ORDER BY TBMIR.RGSN_TS DESC
                    )
                    WHERE rownum = 1
                ) AS CNFA_YN
        FROM
            <include refid="MARKET"/>TB_BOX_MKT_INQU_M TBMIM
        INNER JOIN <include refid="MARKET"/>TB_BOX_MKT_INQU_R TBMIR ON TBMIR.INQR_INFO_ID = TBMIM.INQR_INFO_ID /* 메시지 없는 건은 걸러내기 위해 inner join 사용 */
            AND TBMIR.INFO_SQN = (SELECT MIN(INFO_SQN) FROM <include refid="MARKET"/>TB_BOX_MKT_INQU_R WHERE INQR_INFO_ID = TBMIM.INQR_INFO_ID)

        LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_PDF_INF_M TBMPIM ON TBMPIM.PDF_INFO_ID = TBMIM.PDF_INFO_ID
        LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_PDF_SAL_L TBMPSL ON TBMPSL.PDF_INFO_ID = TBMPIM.PDF_INFO_ID
        LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_FFPC_INF_M TBMFIM ON TBMFIM.UTLINSTT_ID = TBMPIM.SELR_USIS_ID
        LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_FFPC_INF_M TBMFIMM ON TBMFIMM.UTLINSTT_ID = TBMIM.INQU_USIS_ID
        LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_COM_CD_D TBMCCD ON TBMCCD.COM_CD_ID = TBMPSL.COM_PRCUT_ID
        LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_PDF_FIE_R TBMPFR ON TBMPFR.PDF_INFO_ID = TBMPSL.PDF_INFO_ID AND TBMPFR.INFO_SQN = 1 AND FILE_PTRN_ID = #{filePtrnId}
        LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_CTGY_C TBMCC ON TBMCC.CTGY_ID = TBMPIM.PDF_CTGY_ID

        WHERE 1 = 1
            <if test="qnaSearchType != null and qnaSearchType.equals('sen')">
                AND TBMIM.INQU_USIS_ID = #{utlinsttId}
            </if>

            <if test="qnaSearchType != null and qnaSearchType.equals('rec')">
                AND TBMPIM.SELR_USIS_ID = #{utlinsttId}
            </if>

            <if test="pdfNm != null and !pdfNm.equals('')">
                AND TBMPIM.PDF_NM LIKE '%' || #{pdfNm} || '%'
            </if>

            <if test="comCon != null and !comCon.equals('')">
                <if test="qnaSearchType != null and qnaSearchType.equals('sen')">
                    AND TBMFIM.BPLC_NM LIKE '%' || #{comCon} || '%'
                </if>
                <if test="qnaSearchType != null and qnaSearchType.equals('rec')">
                    AND TBMFIMM.BPLC_NM LIKE '%' || #{comCon} || '%'
                </if>
            </if>
        ORDER BY LAST_MESSAGE_DT DESC
        <include refid="pagingFooter"/>
    </select>

    <!--    문의 상세 조회    -->
    <select id="selectQnaInfo" parameterType="RequestSearchQnaVO" resultType="SummaryQnainfoVO">
        SELECT
            TBMIM.INQR_INFO_ID
            , TBMIM.PDF_INFO_ID

            , TBMIM.INQU_USIS_ID
            , TBMIM.INQU_USER_ID

            , TBMPIM.SELR_USIS_ID
            , TBMFIM.BPLC_NM AS SELR_USIS_NAME
            , TBMFIM.RPRSNTV_NM

            , TBMPIM.PDF_NM
            , TBMPIM.AGEN_INF_ID
            , TBMPIM.PDF_STTS_ID
            , TBMPIM.PDF_PGRS_YN
            , TBMPSL.PRC_DSCS_YN

            , TBMCC.TMS3_CLSF_NM AS PDF_CTGY_NAME

            , TBMPSL.PDF_PRC
            , TBMPSL.SALE_PRC

            , TBMPSL.COM_PRCUT_ID
            , TBMCCD.COM_CD_NM AS COM_PRCUT_NAME

            , TBMFAM.FILE_ID AS IMG_FILE_ID
        FROM
            <include refid="MARKET"/>TB_BOX_MKT_INQU_M TBMIM

        LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_PDF_INF_M TBMPIM ON TBMPIM.PDF_INFO_ID = TBMIM.PDF_INFO_ID
        LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_PDF_SAL_L TBMPSL ON TBMPSL.PDF_INFO_ID = TBMPIM.PDF_INFO_ID
        LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_FFPC_INF_M TBMFIM ON TBMFIM.UTLINSTT_ID = TBMPIM.SELR_USIS_ID
        LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_COM_CD_D TBMCCD ON TBMCCD.COM_CD_ID = TBMPSL.COM_PRCUT_ID
        LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_PDF_FIE_R TBMPFR ON TBMPFR.PDF_INFO_ID = TBMPSL.PDF_INFO_ID
            AND TBMPFR.FILE_PTRN_ID = #{filePtrnId}
            AND TBMPFR.INFO_SQN = (SELECT MIN(INFO_SQN) FROM <include refid="MARKET"/>TB_BOX_MKT_PDF_FIE_R WHERE FILE_PTRN_ID = #{filePtrnId} AND PDF_INFO_ID = TBMPSL.PDF_INFO_ID)
        LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_FILE_ATCH_M TBMFAM ON TBMFAM.FILE_ID = TBMPFR.FILE_ID
        LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_CTGY_C TBMCC ON TBMCC.CTGY_ID = TBMPIM.PDF_CTGY_ID

        WHERE 1 = 1
            <choose>
                <when test="sendFlg != null and sendFlg.equals('sen')">
                    AND TBMIM.INQU_USIS_ID = #{utlinsttId}
                </when>
                <otherwise>
                    AND (TBMIM.INQU_USIS_ID = #{utlinsttId} OR TBMPIM.SELR_USIS_ID = #{utlinsttId})
                </otherwise>
            </choose>
            <if test="inqrInfoId != null and !inqrInfoId.equals('')">
                AND TBMIM.INQR_INFO_ID = #{inqrInfoId}
            </if>
            <if test="pdfInfoId != null and !pdfInfoId.equals('')">
                AND TBMIM.PDF_INFO_ID = #{pdfInfoId}
            </if>
    </select>

    <!--    문의 상세 메세지 리스트 조회    -->
    <select id="selectQnaMessageList" parameterType="RequestSearchQnaVO" resultType="QnaMessageVO">
        SELECT
            TBMIR.INQR_INFO_ID
            , TBMIR.INFO_SQN

            , TBMIR.DPMP_USIS_ID
            , TBMIR.DPMP_USER_ID

            , TBMIR.RCVR_USIS_ID
            , TBMIR.RCVR_USER_ID

            , TBMIR.INQU_TYPE_ID AS INQRPTRN_ID
            , TBMIR.RFCD_ID

            , TBMIR.CON
            , TBMIR.RGSN_TS

            , TBMINR.INES_SQN
            , TBMINR.PCSNSTTS_ID

            , CASE WHEN TBMIR.RFCD_ID IS NULL THEN 'Y' ELSE 'N' END AS MESSAGE_FLG
            , CASE WHEN TBMIR.DPMP_USIS_ID = #{utlinsttId} AND TBMIR.DPMP_USER_ID = #{loginUserId} THEN 'Y' ELSE 'N' END AS SENT_MESSAGE_FLG

            , TBMOPR.ORDN_INFO_ID
            , TBMOPR.INFO_SQN AS ORDN_PDF_INFO_SQN
            , TBMOPR.ORDN_STTS_ID

        FROM
            <include refid="MARKET"/>TB_BOX_MKT_INQU_R TBMIR

        LEFT JOIN
            (
                SELECT MAINT.ESTT_INFO_ID, MAINT.INQR_INFO_ID, MAINT.INFO_SQN, MAINT.INES_SQN, MAINT.PCSNSTTS_ID
                FROM <include refid="MARKET"/>TB_BOX_MKT_INES_R MAINT
                INNER JOIN
                    (
                        SELECT INQR_INFO_ID, INFO_SQN, MAX(INES_SQN) MAX_SQN
                        FROM <include refid="MARKET"/>TB_BOX_MKT_INES_R
                        GROUP BY INQR_INFO_ID, INFO_SQN
                    ) SUBT ON MAINT.INQR_INFO_ID = SUBT.INQR_INFO_ID AND MAINT.INFO_SQN = SUBT.INFO_SQN AND MAINT.INES_SQN = SUBT.MAX_SQN
            ) TBMINR ON TBMINR.INQR_INFO_ID = TBMIR.INQR_INFO_ID AND TBMINR.INFO_SQN = TBMIR.INFO_SQN

        LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_ESM_INF_M TBMEIM ON TBMEIM.ESTT_INFO_ID = TBMINR.ESTT_INFO_ID
        LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_ORDER_PDF_R TBMOPR ON TBMOPR.ORDN_INFO_ID = TBMEIM.ORDN_INFO_ID
            AND TBMOPR.INFO_SQN = (SELECT MIN(INFO_SQN) FROM <include refid="MARKET"/>TB_BOX_MKT_ORDER_PDF_R WHERE ORDN_INFO_ID = TBMOPR.ORDN_INFO_ID)

        WHERE 1 = 1
            AND TBMIR.INQR_INFO_ID = #{inqrInfoId}
            AND TBMIR.DEL_YN = 'N'

        ORDER BY TBMIR.INFO_SQN ASC
    </select>

    <!--    문의 메세제 등록   -->
    <insert id="insertQnaMessage" parameterType="QnaMessageVO">
        <selectKey keyProperty="infoSqn" resultType="int" order="AFTER">
            SELECT MAX(INFO_SQN) FROM <include refid="MARKET"/>TB_BOX_MKT_INQU_R WHERE INQR_INFO_ID = #{inqrInfoId}
        </selectKey>
        INSERT INTO <include refid="MARKET"/>TB_BOX_MKT_INQU_R
            (
                INQR_INFO_ID
                , INFO_SQN
                , DPMP_USIS_ID
                , DPMP_USER_ID
                , RCVR_USIS_ID
                , RCVR_USER_ID
                , INQU_TYPE_ID
                , RFCD_ID
                , CON
                , DEL_YN
                , RGSN_USER_ID
                , RGSN_TS
                , AMNN_USER_ID
                , AMNN_TS
            )
        VALUES
            (
                #{inqrInfoId}
                , (
                    SELECT CASE WHEN MAX(INFO_SQN) IS NULL THEN 1 ELSE MAX(INFO_SQN) + 1 END
                    FROM <include refid="MARKET"/>TB_BOX_MKT_INQU_R
                    WHERE INQR_INFO_ID = #{inqrInfoId}
                )
                , #{dpmpUsisId}
                , #{dpmpUserId}
                , #{rcvrUsisId}
                , #{rcvrUserId}
                , #{inqrptrnId}
                , #{rfcdId}
                , #{con}
                , 'N'
                , #{rgsnUserId}
                , CURRENT_TIMESTAMP
                , #{amnnUserId}
                , CURRENT_TIMESTAMP
            )
    </insert>

    <!--    문의 정보 등록    -->
    <insert id="insertQnaInfo" parameterType="QnaInfoVO">
        INSERT INTO <include refid="MARKET"/>TB_BOX_MKT_INQU_M
        (
            INQR_INFO_ID
            , PDF_INFO_ID
            , INQU_USIS_ID
            , INQU_USER_ID
            , RGSN_USER_ID
            , RGSN_TS
            , AMNN_USER_ID
            , AMNN_TS
        )
        VALUES
        (
            #{inqrInfoId}
            , #{pdfInfoId}
            , #{inquUsisId}
            , #{inquUserId}
            , #{rgsnUserId}
            , CURRENT_TIMESTAMP
            , #{amnnUserId}
            , CURRENT_TIMESTAMP
        )
    </insert>

    <!--    메세지 수신확인 이력 등록   -->
    <insert id="insertQnaMessageCheckHistoy" parameterType="qnaMessageCheckHistoyVO">
        INSERT INTO <include refid="MARKET"/>TB_BOX_MKT_INDI_H
        (
            INQR_INFO_ID
            , INFO_SQN
            , CNFA_YN
            , RGSN_USER_ID
            , RGSN_TS
            , AMNN_USER_ID
            , AMNN_TS
            , MDPH_SQN
        ) SELECT
            #{inqrInfoId}
            , #{infoSqn}
            , 'N'
            , #{rgsnUserId}
            , CURRENT_TIMESTAMP
            , #{amnnUserId}
            , CURRENT_TIMESTAMP
            , NVL(MAX(MDPH_SQN),0)+1
        FROM <include refid="MARKET"/>TB_BOX_MKT_INDI_H WHERE INQR_INFO_ID = #{inqrInfoId} AND INFO_SQN = #{infoSqn}
    </insert>

    <!--    메세지 수신확인 이력 수정   -->
    <update id="updateQnaMessageCheckHistoy" parameterType="QnaMessageCheckHistoyVO">
        UPDATE
            <include refid="MARKET"/>TB_BOX_MKT_INDI_H
        SET
            CNFA_YN         = 'Y'
            , AMNN_USER_ID  = #{amnnUserId}
            , AMNN_TS       = CURRENT_TIMESTAMP
        WHERE
            INQR_INFO_ID = #{inqrInfoId}
            AND INFO_SQN = #{infoSqn}
    </update>

    <!--    문의 건수   -->
    <select id="selectQnaCnt" parameterType="RequestSearchQnaVO" resultType="QnaCntVO">
        SELECT
            (SELECT COUNT(1)
             FROM <include refid="MARKET"/>TB_BOX_MKT_INQU_M TBMIM
                INNER JOIN <include refid="MARKET"/>TB_BOX_MKT_INQU_R TBMIR ON TBMIR.INQR_INFO_ID = TBMIM.INQR_INFO_ID /* 메시지 없는 건은 걸러내기 위해 inner join 사용 */
                AND TBMIR.INFO_SQN = (SELECT MIN(INFO_SQN) FROM <include refid="MARKET"/>TB_BOX_MKT_INQU_R WHERE INQR_INFO_ID = TBMIM.INQR_INFO_ID)
                LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_PDF_INF_M TBMPIM ON TBMIM.PDF_INFO_ID = TBMPIM.PDF_INFO_ID
                LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_FFPC_INF_M TBMFIM ON TBMFIM.UTLINSTT_ID = TBMPIM.SELR_USIS_ID
             WHERE 1=1
                AND TBMIM.INQU_USIS_ID = #{utlinsttId}
                <if test="pdfNm != null and !pdfNm.equals('')">
                    AND TBMPIM.PDF_NM LIKE '%' || #{pdfNm} || '%'
                </if>
                <if test="comCon != null and !comCon.equals('')">
                    AND TBMFIM.BPLC_NM LIKE '%' || #{comCon} || '%'
                </if>
            ) AS DPMP_SUM_CNT
             , (SELECT COUNT(1)
                FROM <include refid="MARKET"/>TB_BOX_MKT_INQU_M TBMIM
                    INNER JOIN <include refid="MARKET"/>TB_BOX_MKT_INQU_R TBMIR ON TBMIR.INQR_INFO_ID = TBMIM.INQR_INFO_ID /* 메시지 없는 건은 걸러내기 위해 inner join 사용 */
                    AND TBMIR.INFO_SQN = (SELECT MIN(INFO_SQN) FROM <include refid="MARKET"/>TB_BOX_MKT_INQU_R WHERE INQR_INFO_ID = TBMIM.INQR_INFO_ID)
                    LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_PDF_INF_M TBMPIM ON TBMIM.PDF_INFO_ID = TBMPIM.PDF_INFO_ID
                    LEFT JOIN <include refid="MARKET"/>TB_BOX_MKT_FFPC_INF_M TBMFIM ON TBMFIM.UTLINSTT_ID = TBMPIM.SELR_USIS_ID
                WHERE 1=1
                    AND TBMPIM.SELR_USIS_ID = #{utlinsttId}
                    <if test="pdfNm != null and !pdfNm.equals('')">
                        AND TBMPIM.PDF_NM LIKE '%' || #{pdfNm} || '%'
                    </if>
                    <if test="comCon != null and !comCon.equals('')">
                        <if test="qnaSearchType != null and qnaSearchType.equals('sen')">
                            AND TBMFIM.BPLC_NM LIKE '%' || #{comCon} || '%'
                        </if>
                        <if test="qnaSearchType != null and qnaSearchType.equals('rec')">
                            AND TBMFIMM.BPLC_NM LIKE '%' || #{comCon} || '%'
                        </if>
                    </if>
        ) AS RCVR_SUM_CNT
        FROM DUAL
    </select>

</mapper>