<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ibk.sb.restapi.biz.service.category.repo.CategoryRepo">

    <sql id="MARKET"><include refid="com.ibk.sb.restapi.biz.service.common.repo.SchemaRepo.MARKET"/></sql>

    <!--    카테고리 정보 조회  -->
    <select id="selectCategoryList" parameterType="CategoryVO" resultType="ResponseCategoryVO">
        SELECT
        <choose>
            <when test="searchCategoryNum.equals('two')">
                TMS2_CLSF_CD AS clsfCd
                , TMS2_CLSF_NM AS clsfNm
            </when>
            <when test="searchCategoryNum.equals('thr')">
                TMS3_CLSF_CD AS clsfCd
                , TMS3_CLSF_NM AS clsfNm
            </when>
            <when test="searchCategoryNum.equals('for')">
                TMS4_CLSF_CD AS clsfCd
                , TMS4_CLSF_NM AS clsfNm
            </when>
            <when test="searchCategoryNum.equals('fiv')">
                CTGY_ID
                , TMS5_CLSF_CD AS clsfCd
                , TMS5_CLSF_NM AS clsfNm
            </when>
            <when test="searchCategoryNum.equals('six')">
                CTGY_ID
                , TMS1_CLSF_NM
                , TMS1_CLSF_CD
                , TMS2_CLSF_NM
                , TMS2_CLSF_CD
                , TMS3_CLSF_NM
                , TMS3_CLSF_CD
                , TMS4_CLSF_NM
                , TMS4_CLSF_CD
                , TMS5_CLSF_NM
                , TMS5_CLSF_CD

                , TMS5_CLSF_NM AS clsfNm
            </when>
        </choose>
        FROM
        <include refid="MARKET"/>TB_BOX_MKT_CTGY_C
        WHERE
        USE_YN = 'Y'
        <choose>
            <when test="searchCategoryNum.equals('two')">
                AND TMS1_CLSF_CD = #{tms1ClsfCd}
                GROUP BY TMS2_CLSF_CD, TMS2_CLSF_NM
            </when>
            <when test="searchCategoryNum.equals('thr')">
                AND TMS1_CLSF_CD = #{tms1ClsfCd}
                AND TMS2_CLSF_CD = #{tms2ClsfCd}
                GROUP BY TMS3_CLSF_CD, TMS3_CLSF_NM
            </when>
            <when test="searchCategoryNum.equals('for')">
                AND TMS1_CLSF_CD = #{tms1ClsfCd}
                AND TMS2_CLSF_CD = #{tms2ClsfCd}
                AND TMS3_CLSF_CD = #{tms3ClsfCd}
                GROUP BY TMS4_CLSF_CD, TMS4_CLSF_NM
            </when>
            <when test="searchCategoryNum.equals('fiv')">
                AND TMS1_CLSF_CD = #{tms1ClsfCd}
                AND TMS2_CLSF_CD = #{tms2ClsfCd}
                AND TMS3_CLSF_CD = #{tms3ClsfCd}
                AND TMS4_CLSF_CD = #{tms4ClsfCd}
                GROUP BY CTGY_ID, TMS5_CLSF_CD, TMS5_CLSF_NM
            </when>
            <when test="searchCategoryNum.equals('six')">
                AND TMS1_CLSF_CD = #{tms1ClsfCd}
                AND TMS2_CLSF_CD = #{tms2ClsfCd}
                AND TMS3_CLSF_CD = #{tms3ClsfCd}
                AND TMS4_CLSF_CD = #{tms4ClsfCd}
                AND TMS5_CLSF_CD = #{tms5ClsfCd}
            </when>

        </choose>
        ORDER BY clsfNm
    </select>

    <!-- 카테고리 레벨별 목록 조회 -->
    <select id="selectCategoryDepthList" parameterType="Map" resultType="CategoryActiveVO">

        SELECT
        DISTINCT CTGY_PARENT_CD
        ,CTGY_CD
        ,CTGY_NM
        ,CASE WHEN CLSF_CNT > 0 THEN 'Y' ELSE 'N' END AS USE_YN
        FROM
        (
        SELECT
        <choose>
            <when test="depth.equals(1)">
                TBMCC.TMS1_CLSF_CD AS CTGY_PARENT_CD
                ,TBMCC.TMS1_CLSF_CD AS CTGY_CD
                ,TBMCC.TMS1_CLSF_NM AS CTGY_NM
                ,(
                SELECT
                COUNT(*)
                FROM
                <include refid="MARKET"/>TB_BOX_MKT_CTGY_C
                WHERE 1=1
                AND USE_YN = 'Y'
                AND TMS1_CLSF_CD = TBMCC.TMS1_CLSF_CD
                ) AS CLSF_CNT
            </when>
            <when test="depth.equals(2)">
                TBMCC.TMS1_CLSF_CD AS CTGY_PARENT_CD
                ,TBMCC.TMS1_CLSF_CD||TBMCC.TMS2_CLSF_CD AS CTGY_CD
                ,TBMCC.TMS2_CLSF_NM AS CTGY_NM
                ,(
                SELECT
                COUNT(*)
                FROM
                <include refid="MARKET"/>TB_BOX_MKT_CTGY_C
                WHERE 1=1
                AND USE_YN = 'Y'
                AND TMS1_CLSF_CD = TBMCC.TMS1_CLSF_CD
                AND TMS2_CLSF_CD = TBMCC.TMS2_CLSF_CD
                ) AS CLSF_CNT
            </when>
            <when test="depth.equals(3)">
                TBMCC.TMS1_CLSF_CD||TBMCC.TMS2_CLSF_CD AS CTGY_PARENT_CD
                ,TBMCC.TMS1_CLSF_CD||TBMCC.TMS2_CLSF_CD||TBMCC.TMS3_CLSF_CD AS CTGY_CD
                ,TBMCC.TMS3_CLSF_NM AS CTGY_NM
                ,(
                SELECT
                COUNT(*)
                FROM
                <include refid="MARKET"/>TB_BOX_MKT_CTGY_C
                WHERE 1=1
                AND USE_YN = 'Y'
                AND TMS1_CLSF_CD = TBMCC.TMS1_CLSF_CD
                AND TMS2_CLSF_CD = TBMCC.TMS2_CLSF_CD
                AND TMS3_CLSF_CD = TBMCC.TMS3_CLSF_CD
                ) AS CLSF_CNT
            </when>
            <when test="depth.equals(4)">
                TBMCC.TMS1_CLSF_CD||TBMCC.TMS2_CLSF_CD||TBMCC.TMS3_CLSF_CD AS CTGY_PARENT_CD
                ,TBMCC.TMS1_CLSF_CD||TBMCC.TMS2_CLSF_CD||TBMCC.TMS3_CLSF_CD||TBMCC.TMS4_CLSF_CD AS CTGY_CD
                ,TBMCC.TMS4_CLSF_NM AS CTGY_NM
                ,(
                SELECT
                COUNT(*)
                FROM
                <include refid="MARKET"/>TB_BOX_MKT_CTGY_C
                WHERE 1=1
                AND USE_YN = 'Y'
                AND TMS1_CLSF_CD = TBMCC.TMS1_CLSF_CD
                AND TMS2_CLSF_CD = TBMCC.TMS2_CLSF_CD
                AND TMS3_CLSF_CD = TBMCC.TMS3_CLSF_CD
                AND TMS4_CLSF_CD = TBMCC.TMS4_CLSF_CD
                ) AS CLSF_CNT
            </when>
            <when test="depth.equals(5)">
                TBMCC.TMS1_CLSF_CD||TBMCC.TMS2_CLSF_CD||TBMCC.TMS3_CLSF_CD||TBMCC.TMS4_CLSF_CD AS CTGY_PARENT_CD
                ,TBMCC.TMS1_CLSF_CD||TBMCC.TMS2_CLSF_CD||TBMCC.TMS3_CLSF_CD||TBMCC.TMS4_CLSF_CD||TBMCC.TMS5_CLSF_CD AS CTGY_CD
                ,TBMCC.TMS5_CLSF_NM AS CTGY_NM
                ,(
                SELECT
                COUNT(*)
                FROM
                <include refid="MARKET"/>TB_BOX_MKT_CTGY_C
                WHERE 1=1
                AND USE_YN = 'Y'
                AND TMS1_CLSF_CD = TBMCC.TMS1_CLSF_CD
                AND TMS2_CLSF_CD = TBMCC.TMS2_CLSF_CD
                AND TMS3_CLSF_CD = TBMCC.TMS3_CLSF_CD
                AND TMS4_CLSF_CD = TBMCC.TMS4_CLSF_CD
                AND TMS5_CLSF_CD = TBMCC.TMS5_CLSF_CD
                ) AS CLSF_CNT
            </when>
        </choose>
        FROM
        <include refid="MARKET"/>TB_BOX_MKT_CTGY_C TBMCC
        WHERE 1=1
        <if test="parentCode != null and !parentCode.equals('')">
            AND TBMCC.TMS1_CLSF_CD = #{parentCode}
        </if>
        <choose>
            <when test="depth.equals(1)">
                GROUP BY TBMCC.TMS1_CLSF_NM,TBMCC.TMS1_CLSF_CD
            </when>
            <when test="depth.equals(2)">
                GROUP BY TBMCC.TMS1_CLSF_NM,TBMCC.TMS1_CLSF_CD, TBMCC.TMS2_CLSF_NM,TBMCC.TMS2_CLSF_CD
            </when>
            <when test="depth.equals(3)">
                GROUP BY TBMCC.TMS1_CLSF_NM,TBMCC.TMS1_CLSF_CD,TBMCC.TMS2_CLSF_NM,TBMCC.TMS2_CLSF_CD,TBMCC.TMS3_CLSF_NM,TBMCC.TMS3_CLSF_CD
            </when>
            <when test="depth.equals(4)">
                GROUP BY TBMCC.TMS1_CLSF_NM,TBMCC.TMS1_CLSF_CD,TBMCC.TMS2_CLSF_NM,TBMCC.TMS2_CLSF_CD,TBMCC.TMS3_CLSF_NM,TBMCC.TMS3_CLSF_CD,TBMCC.TMS4_CLSF_NM,TBMCC.TMS4_CLSF_CD
            </when>
            <when test="depth.equals(5)">
                GROUP BY TBMCC.TMS1_CLSF_NM,TBMCC.TMS1_CLSF_CD,TBMCC.TMS2_CLSF_NM,TBMCC.TMS2_CLSF_CD,TBMCC.TMS3_CLSF_NM,TBMCC.TMS3_CLSF_CD,TBMCC.TMS4_CLSF_NM,TBMCC.TMS4_CLSF_CD,TBMCC.TMS5_CLSF_NM,TBMCC.TMS5_CLSF_CD
            </when>
        </choose>
        ) ORDER BY USE_YN DESC, CTGY_CD

    </select>
</mapper>